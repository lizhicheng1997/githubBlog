---
title: 微信公众号
date: 2019-05-04 11:27:59
tags:
  - 微信
categories:
  - 微信公众号
top: 100
copyright: true
---

# 一、微信网页授权

## 1. 配置步骤
{% blockquote %}
1. 进入微信公众号平台，“公众号设置->功能设置”，配置网页授权域名；
2. 在项目后台配置授权的scopes和回调页面：
  2.1 WECHAT_OFFICIAL_ACCOUNT_OAUTH_SCOPES = 'snsapi_userinfo'
  2.2 WECHAT_OFFICIAL_ACCOUNT_OAUTH_CALLBACK = '/public/index.php/wechat/auth-callBack'
3. 在微信配置文件中开启和配置：OAuth 配置；
4. 进入项目页面时，先判断用户是否登录或授权（通过session判断）：
  4.1 已登录或授权：更新数据库该用户信息，跳转项目页面；
  4.2 未登录或授权：跳转到授权登录页（配置文件中已配置好的路径），将授权后得到的用户信息写入session中保存，再跳转到项目页面；
{% endblockquote %}

## 2. 实例代码
```
<?php

namespace App\Http\Controllers\Wechat;

use App\Http\Controllers\Controller;
use App\Models\User;
use Illuminate\Http\Request;
use Overtrue\LaravelWeChat\Facade;

/**
* Class AuthLoginController
* @package App\Http\Controllers\Wechat
* 测试授权登录
*/
class AuthLoginController extends Controller
{
    /**
     * @param Request $request
     * @return string|\Symfony\Component\HttpFoundation\RedirectResponse
     * @throws \Exception
     * 授权才能访问
     */
    public function index(Request $request)
    {
        error_reporting(E_ALL ^ E_NOTICE ^ E_WARNING);
        $app = Facade::officialAccount();
        $oauth = $app->oauth;
        // 未登录跳转授权登录
        if (!$request->session()->has('wechat_user')) {
            session(['target_url' => '/wechat/auth-login']);
            return $oauth->redirect();
        }

        $userMessage = $request->session()->get('wechat_user');

        /*// 已经登录过，将用户信息存储到数据库中
        $user = new User;
        $user->official_openid = $userMessage['id'];
        $user->name = $userMessage['name'];
        $user->avatar = $userMessage['avatar'];
        $user->unionid = $userMessage['token']->unionid;
        $user->auth_token = $userMessage['token']->access_token;
        $user->is_new = 1;
        if (!$user->save()) {
            throw new \Exception('写入用户信息失败');
        }*/

        echo '<pre>';
        print_r($userMessage);
        echo '</pre>';

        session(['target_url' => null]);
        session(['wechat_user' => null]);
        return '授权登录成功';
    }

    /**
     * @param Request $request
     * @return \Illuminate\Http\RedirectResponse|\Illuminate\Routing\Redirector
     * 授权回调页
     */
    public function callBack(Request $request)
    {
        error_reporting(E_ALL ^ E_NOTICE ^ E_WARNING);
        $app = Facade::officialAccount();
        $user = $app->oauth->user()->toArray();
        $user['code'] = $request->code;
        $user['state'] = $request->state;
        session(['wechat_user' => $user]);
        $targetUrl = $request->session()->get('target_url', '/');
        return redirect($targetUrl);
    }

    // 生成登录二维码
    public function createQrcode()
    {
        return \QrCode::size(300)->generate('http://app.shwto.com/public/index.php/wechat/auth-login');
    }
}
```
